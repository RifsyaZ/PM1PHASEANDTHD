<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoring Listrik 1 Fase</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 5px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .status-item {
      text-align: center;
      padding: 10px;
      min-width: 120px;
    }
    .status-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }
    .status-label {
      font-size: 0.9rem;
      color: #7f8c8d;
    }
    .chart-container {
      margin: 20px 0;
      position: relative;
      height: 200px;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    .chart-title {
      text-align: center;
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
    }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
    }
    .badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      color: white;
    }
    .normal {
      background-color: #2ecc71;
    }
    .warning {
      background-color: #f39c12;
    }
    .danger {
      background-color: #e74c3c;
    }
    .update-time {
      text-align: right;
      font-size: 0.8rem;
      color: #95a5a6;
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .status-bar {
        flex-direction: column;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Monitoring Listrik 1 Fase</h1>
    <p class="subtitle">Sistem pemantauan parameter listrik real-time</p>
    
    <div class="status-bar">
      <div class="status-item">
        <div class="status-label"></div>
        <div class="status-value"></div>
        <div class="status-label"></div>
      </div>
      <div class="status-item">
        <div class="status-label"></div>
        <div class="status-value" id="frequency-value"></div>
        <div class="status-label"></div>
      </div>
      <div class="status-item">
        <div class="status-label"></div>
        <div class="status-value" id="current-value"></div>
        <div class="status-label"></div>
      </div>
      <div class="status-item">
        <div class="status-label"></div>
        <div class="status-value" id="temp-value"></div>
        <div class="status-label"></div>
      </div>
      <div class="status-item">
        <div class="status-label"></div>
        <div class="status-value" id="humidity-value"></div>
        <div class="status-label"></div>
      </div>
    </div>
    
    <div class="chart-grid">
      <!-- Voltage Chart -->
      <div class="chart-container">
        <div class="chart-title">Tegangan (V)</div>
        <canvas id="voltageChart"></canvas>
      </div>
      
      <!-- Frequency Chart -->
      <div class="chart-container">
        <div class="chart-title">Frekuensi (Hz)</div>
        <canvas id="frequencyChart"></canvas>
      </div>
      
      <!-- Current Chart -->
      <div class="chart-container">
        <div class="chart-title">Arus (A)</div>
        <canvas id="currentChart"></canvas>
      </div>
      
      <!-- Temperature Chart -->
      <div class="chart-container">
        <div class="chart-title">Suhu (째C)</div>
        <canvas id="tempChart"></canvas>
      </div>
      
      <!-- Humidity Chart -->
      <div class="chart-container">
        <div class="chart-title">Kelembaban (%)</div>
        <canvas id="humidityChart"></canvas>
      </div>
      
      <!-- Distorsi Arus -->
      <div class="chart-container">
        <div class="chart-title">Distorsi Arus</div>
        <canvas id="distortionChart"></canvas>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Parameter</th>
          <th>DL1</th>
          <th>DL2</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Tegangan (V)</td>
          <td id="dl1-voltage">--.--</td>
          <td id="dl2-voltage">--.--</td>
          <td><span class="badge" id="voltage-status">-</span></td>
        </tr>
        <tr>
          <td>Frekuensi (Hz)</td>
          <td id="dl1-frequency">--.--</td>
          <td id="dl2-frequency">--.--</td>
          <td><span class="badge" id="frequency-status">-</span></td>
        </tr>
        <tr>
          <td>Arus (A)</td>
          <td id="dl1-current">--.------</td>
          <td id="dl2-current">--.------</td>
          <td><span class="badge" id="current-status">-</span></td>
        </tr>
        <tr>
          <td>Suhu (째C)</td>
          <td id="dl1-temp">--.-</td>
          <td id="dl2-temp">--.-</td>
          <td><span class="badge" id="temp-status">-</span></td>
        </tr>
        <tr>
          <td>Kelembaban (%)</td>
          <td id="dl1-humidity">--.-</td>
          <td id="dl2-humidity">--.-</td>
          <td><span class="badge" id="humidity-status">-</span></td>
        </tr>
      </tbody>
    </table>
    
    <div class="update-time" id="update-time">Terakhir diperbarui: -</div>
  </div>

  <script>
    // URL Google Sheets Anda
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzLzDatUCJa86sgqfWywphXYDnL7GNFYrFlvV92Oy-XgThq87sKykq9TtOqVWWAucYP/exec";
    
    // Variabel global untuk chart
    let voltageChart, frequencyChart, currentChart, tempChart, humidityChart, distortionChart;
    
    // Fungsi untuk memformat nilai
    function formatValue(val, decimals = 2) {
      if (val === null || val === undefined || val === '' || val === '---') return '---';
      const num = parseFloat(val);
      return isNaN(num) ? '---' : num.toFixed(decimals);
    }
    
    // Fungsi untuk mengambil data dari Google Sheets
    async function fetchData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();
        
        if (!data || data.length === 0) {
          console.warn("Tidak ada data yang ditemukan");
          return null;
        }
        
        console.log("Data dari Sheets:", data);
        return data;
      } catch (error) {
        console.error("Gagal mengambil data:", error);
        document.getElementById('update-time').textContent = "Gagal memuat data: " + error.message;
        document.getElementById('update-time').style.color = "red";
        return null;
      }
    }
    
    // Fungsi untuk memproses dan menampilkan data
    async function updateDashboard() {
      const data = await fetchData();
      if (!data) return;
      
      // Ambil data terbaru (indeks terakhir dalam array)
      const latestData = data[data.length - 1];
      console.log("Data terakhir:", latestData);
      
      // Update nilai real-time
      document.getElementById('voltage-value').textContent = formatValue(latestData.V1);
      document.getElementById('frequency-value').textContent = formatValue(latestData.F1);
      document.getElementById('current-value').textContent = formatValue(latestData.AED1, 6);
      document.getElementById('temp-value').textContent = formatValue(latestData.T1);
      document.getElementById('humidity-value').textContent = formatValue(latestData.H1);
      
      // Update tabel parameter
      document.getElementById('dl1-voltage').textContent = formatValue(latestData.V1);
      document.getElementById('dl2-voltage').textContent = formatValue(latestData.V2);
      document.getElementById('dl1-frequency').textContent = formatValue(latestData.F1);
      document.getElementById('dl2-frequency').textContent = formatValue(latestData.F2);
      document.getElementById('dl1-current').textContent = formatValue(latestData.AED1, 6);
      document.getElementById('dl2-current').textContent = formatValue(latestData.AED2, 6);
      document.getElementById('dl1-temp').textContent = formatValue(latestData.T1);
      document.getElementById('dl2-temp').textContent = formatValue(latestData.T2);
      document.getElementById('dl1-humidity').textContent = formatValue(latestData.H1);
      document.getElementById('dl2-humidity').textContent = formatValue(latestData.H2);
      
      // Update status
      updateStatus('voltage', latestData.V1, latestData.V2);
      updateStatus('frequency', latestData.F1, latestData.F2);
      updateStatus('current', latestData.AED1, latestData.AED2);
      updateStatus('temp', latestData.T1, latestData.T2);
      updateStatus('humidity', latestData.H1, latestData.H2);
      
      // Update semua grafik dengan data historis (15 data terakhir)
      updateCharts(data.slice(-15));
      
      // Update waktu terakhir
      const now = new Date();
      document.getElementById('update-time').textContent = "Terakhir diperbarui: " + now.toLocaleTimeString();
    }
    
    // Fungsi untuk update status
    function updateStatus(type, value1, value2) {
      const element = document.getElementById(type + '-status');
      const val1 = parseFloat(value1) || 0;
      const val2 = parseFloat(value2) || 0;
      
      // Logika status sederhana (bisa disesuaikan)
      if (type === 'voltage') {
        const avg = (val1 + val2) / 2;
        if (avg < 200 || avg > 250) {
          element.className = "badge danger";
          element.textContent = "Bahaya";
        } else if (Math.abs(val1 - val2) > 10) {
          element.className = "badge warning";
          element.textContent = "Peringatan";
        } else {
          element.className = "badge normal";
          element.textContent = "Normal";
        }
      }
      else if (type === 'frequency') {
        const avg = (val1 + val2) / 2;
        if (avg < 49.5 || avg > 50.5) {
          element.className = "badge danger";
          element.textContent = "Bahaya";
        } else {
          element.className = "badge normal";
          element.textContent = "Normal";
        }
      }
      else if (type === 'current') {
        if (val1 > 5) {
          element.className = "badge danger";
          element.textContent = "Bahaya";
        } else if (val1 > 1) {
          element.className = "badge warning";
          element.textContent = "Peringatan";
        } else {
          element.className = "badge normal";
          element.textContent = "Normal";
        }
      }
      else if (type === 'temp') {
        const avg = (val1 + val2) / 2;
        if (avg > 40) {
          element.className = "badge danger";
          element.textContent = "Panas";
        } else if (avg > 35) {
          element.className = "badge warning";
          element.textContent = "Hangat";
        } else {
          element.className = "badge normal";
          element.textContent = "Normal";
        }
      }
      else if (type === 'humidity') {
        const avg = (val1 + val2) / 2;
        if (avg > 70 || avg < 30) {
          element.className = "badge warning";
          element.textContent = "Ekstrem";
        } else {
          element.className = "badge normal";
          element.textContent = "Normal";
        }
      }
    }
    
    // Fungsi untuk mengupdate semua grafik
    function updateCharts(dataArray) {
      const labels = dataArray.map((item, index) => {
        // Format waktu dari timestamp
        const date = item.Timestamp ? new Date(item.Timestamp) : new Date();
        return date.toLocaleTimeString();
      });
      
      // Initialize charts if not already initialized
      if (!voltageChart) {
        initCharts();
      }
      
      // Update Voltage Chart
      updateLineChart(voltageChart, 
        labels,
        dataArray.map(item => parseFloat(item.V1) || 0),
        dataArray.map(item => parseFloat(item.V2) || 0),
        'Tegangan (V)',
        '#3498db',
        '#e74c3c'
      );
      
      // Update Frequency Chart
      updateLineChart(frequencyChart, 
        labels,
        dataArray.map(item => parseFloat(item.F1) || 0),
        dataArray.map(item => parseFloat(item.F2) || 0),
        'Frekuensi (Hz)',
        '#9b59b6',
        '#3498db'
      );
      
      // Update Current Chart
      updateLineChart(currentChart, 
        labels,
        dataArray.map(item => parseFloat(item.AED1) || 0),
        dataArray.map(item => parseFloat(item.AED2) || 0),
        'Arus (A)',
        '#e67e22',
        '#d35400'
      );
      
      // Update Temperature Chart
      updateLineChart(tempChart, 
        labels,
        dataArray.map(item => parseFloat(item.T1) || 0),
        dataArray.map(item => parseFloat(item.T2) || 0),
        'Suhu (째C)',
        '#e74c3c',
        '#c0392b'
      );
      
      // Update Humidity Chart
      updateLineChart(humidityChart, 
        labels,
        dataArray.map(item => parseFloat(item.H1) || 0),
        dataArray.map(item => parseFloat(item.H2) || 0),
        'Kelembaban (%)',
        '#3498db',
        '#2980b9'
      );
      
      // Update Distortion Chart (Gauge)
      const latestDistortion = dataArray[dataArray.length - 1].AED1 ? 
        (parseFloat(dataArray[dataArray.length - 1].AED1) * 100) : 0;
      updateGaugeChart(distortionChart, latestDistortion);
    }
    
    // Fungsi untuk inisialisasi semua chart
    function initCharts() {
      // Voltage Chart
      const voltageCtx = document.getElementById('voltageChart').getContext('2d');
      voltageChart = new Chart(voltageCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'DL1 Voltage',
              data: [],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            },
            {
              label: 'DL2 Voltage',
              data: [],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: getChartOptions('Tegangan (V)')
      });
      
      // Frequency Chart
      const frequencyCtx = document.getElementById('frequencyChart').getContext('2d');
      frequencyChart = new Chart(frequencyCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'DL1 Frequency',
              data: [],
              borderColor: '#9b59b6',
              backgroundColor: 'rgba(155, 89, 182, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            },
            {
              label: 'DL2 Frequency',
              data: [],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: getChartOptions('Frekuensi (Hz)')
      });
      
      // Current Chart
      const currentCtx = document.getElementById('currentChart').getContext('2d');
      currentChart = new Chart(currentCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'DL1 Current',
              data: [],
              borderColor: '#e67e22',
              backgroundColor: 'rgba(230, 126, 34, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            },
            {
              label: 'DL2 Current',
              data: [],
              borderColor: '#d35400',
              backgroundColor: 'rgba(211, 84, 0, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: getChartOptions('Arus (A)')
      });
      
      // Temperature Chart
      const tempCtx = document.getElementById('tempChart').getContext('2d');
      tempChart = new Chart(tempCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'DL1 Temperature',
              data: [],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            },
            {
              label: 'DL2 Temperature',
              data: [],
              borderColor: '#c0392b',
              backgroundColor: 'rgba(192, 57, 43, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: getChartOptions('Suhu (째C)')
      });
      
      // Humidity Chart
      const humidityCtx = document.getElementById('humidityChart').getContext('2d');
      humidityChart = new Chart(humidityCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'DL1 Humidity',
              data: [],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            },
            {
              label: 'DL2 Humidity',
              data: [],
              borderColor: '#2980b9',
              backgroundColor: 'rgba(41, 128, 185, 0.1)',
              borderWidth: 1,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: getChartOptions('Kelembaban (%)')
      });
      
      // Distortion Chart (Gauge)
      const distortionCtx = document.getElementById('distortionChart').getContext('2d');
      distortionChart = new Chart(distortionCtx, {
        type: 'doughnut',
        data: {
          labels: ['Distorsi', ''],
          datasets: [{
            data: [0, 100],
            backgroundColor: ['#e74c3c', '#f2f2f2'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          rotation: -90,
          circumference: 180,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              enabled: false
            }
          }
        }
      });
    }
    
    // Fungsi untuk mendapatkan opsi chart
    function getChartOptions(title) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: title
            }
          },
          x: {
            title: {
              display: true,
              text: 'Waktu'
            }
          }
        }
      };
    }
    
    // Fungsi untuk update line chart
    function updateLineChart(chart, labels, dl1Data, dl2Data, title, color1, color2) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = dl1Data;
      chart.data.datasets[1].data = dl2Data;
      chart.update();
    }
    
    // Fungsi untuk update gauge chart
    function updateGaugeChart(chart, value) {
      chart.data.datasets[0].data = [value, 100-value];
      chart.update();
    }
    
    // Inisialisasi dashboard
    function initDashboard() {
      // Inisialisasi semua chart terlebih dahulu
      initCharts();
      
      // Jalankan update pertama dan set interval
      updateDashboard();
      setInterval(updateDashboard, 2000); // Update setiap 2 detik
    }
    
    // Jalankan dashboard saat halaman dimuat
    window.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>